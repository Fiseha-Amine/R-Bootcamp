---
title: "Analysis of Rental Housing Market"
author: 'Fiseha Amine,Martina Schüpbach-Wolf  '
date: "02 02 2021"
output:
  html_document: default
  pdf_document: default
---

\newpage 
\tableofcontents
\newpage



#######################
--> Questions:

Am Schluss:
  - Datum am Schluss der Arbeit noch anpassen
  - viele (head) und (str) "unterdrücken / und auch das Zeigen der ganzen Datensätze
  - code der nicht mehr gebraucht wird - löschen
  - alle "labels" benannt? {r}
  - fett, unterstrichen, kursiv...
  - Achsenbeschriftungen, Überschriften Plots
  - fit easy models
  
  

- Text "Missing values" unvollständig. Was wollen wir hier genau wissen??? Jenachdem Output anpassen.
      - Dann code anpassen.
      - Tabelle einbauen?
      - Export Bild - plotly
      

#######################


# Introduction
This analysis is done as part of the R-Bootcamp module from HS 2020. The aim of the analysis within this scope is to experiment with the different functionalities and methods introduced in this course to answer some analytical and hypothetical research questions.


# Aim of Analysis
Within this work we will analyse the house renting market in Switzerland with the help of open source data from the year 2019. Some of the analysis done in this work are:

- 1. Analyze the price in relation to geography and per canton
- 2. Show where are most apartments available (im Verhältnis zur Gemeindgrösse)
- 3. Show where are the most expensive apartments (canton/community)
- 4. Show where are the biggest apartments
- 5. Show what kind of apartments are mostly available
- 6. Is there a relation ship of the number of people in the canton and size of apartments?


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Libraries
```{r, message=FALSE}
library(readxl)
library(tidyverse)
library(dplyr)
library(mlbench)
library(mice)
library(ggplot2)
library(plotly)
library(shiny)
```


```{r,needed for the plotly export to PDF}

#install.packages("webshot")
#webshot::install_phantomjs()
```


# Data Import
The data set was downloaded from "Datenportal Schweiz_Wohungsmieten": <https://datenportal.info/wohnungsmarkt/wohnungsmieten/>

It contains the following attributes (in German): 
  ID, Year, Quarter, Apartment type, Room, Area, Rent Gross, Square Meter, Price Gross, Address, Postcode and City, Move-In Date,Building Coordinates, and Canton.

```{r, Data Import}
#Because the data contain "Umlaute" we use "UTF-8" for the read in.
data <- read.csv2("mietinserate_v1.csv", header = TRUE, fileEncoding = "UTF-8")
head(data)
str(data)
summary(data)
```


## Join with second data set
To also have an overview of the number of residents in the cantons, we add a new data set.
We extracted the data set from: <https://www.citypopulation.de/de/switzerland/cities/>. It contains the column names: Kanton, KT, Hauptstädte, G.Fläche, Einwohner_1980, Einwohner_1990, Einwohner_2000, Einwohner_2010, and Einwohner_2019.

```{r, Join}
#Read new data set and join new data set to our data set.
data_canton <- read_xlsx("SchweizKantone_Einwohner_org.xlsx", skip = 3)
# head(data_canton)
# str(data_canton)

#change names of original 4th row (now 1st) of the data set to have those as the column names and for the join preparation
data_canton <- rename(data_canton, Kanton = Schweiz, KT = CHE,  Hauptstädte = Bern, G.Fläche = "41285", Einwohner_1980 = "6365960", Einwohner_1990 = "6873687", Einwohner_2000 = "7288010", Einwohner_2010 = "7870134", Einwohner_2019 = "8603899")
#head(data_canton)

#join data sets
data_left_join <- left_join(data, data_canton, by = "KT")
head(data_left_join)
#data_left_join
```


# Data Preparation
For the upcoming analysis the data needs to get formatted and cleaned. We transform the data into a data frame, transform numeric data into numeric and transform the date data into the correct format. We also rename column names for better readability.

```{r, Data Preparation}

data_2 <- as.data.frame(data_left_join)

#transform data
data_2$Zimmer = as.numeric(data_left_join$Zimmer)
data_2$Fläche = as.numeric(data_left_join$Fläche)
data_2[data_2 == ""] <- NA
data_2$Bezugsdatum =as.Date(data_left_join$Bezugsdatum, "%d.%m.%Y")

#rename data columns for a better readability
data_1 <- rename(data_2, W.Type = Wohnungstyp, Miete = Mietpreis_Brutto, Quad_m = Quadratmeterpreis_Brutto, Bezug = Bezugsdatum, W.Fläche = Fläche)
head(data_1)
```


##Delete Columns
Here we delete columns that are not needed within the scope of this analysis. Those columns appear in the dataset after joining the two different datasets in the previous step.

```{r, Delete Columns}

#delete columns that are not needed anymore
data_3 <- data_1 %>% select(-Einwohner_1980, -Einwohner_1990, -Einwohner_2000, -Einwohner_2010)
head(data_3)
```


## Data Modification
In this step we split the column "PLZ_Ort" which consists a postal code and city name to PLZ and Ort. 

```{r, slit PLZ_ORT}
data_sep <- data_3$PLZ_Ort%>%
  str_match('(.*\\d) (.*)') %>%
  as_tibble() %>%
  select(2:3) %>%
  set_names(c('PLZ', 'Ort'))
head(data_sep)
```


As this columns are saved separately from the main dataset, we merge it again to the main dataset and remove the old column "PLZ_Ort".

```{r, Merge PLZ_ORT}

#delete "PLZ_ORT" column and merge the 2 new columns that we created through separating in the previos step
data_sort <- data_3%>%select(-PLZ_Ort)
data_clean <- bind_cols(data_sort, data_sep)
data_clean
```


# Graphical Analysis
With the help of graphical visualization we try to see if there are some patterns, outliers, missing values, and if the distribution of the dataset is normal. 


## Missing values

Below a numerical example and a graphical analysis of all missing data is applied to have an overview of the missing values and their distribution within the dataset. This is necessary to avoid bias in the dataset and have a balanced representance of all cantons equally. For this reason we observe which cantons have how many NAs and if any action (deleting, imputing, replacing, etc.) is needed.

```{r, table shows all NAs}
colSums(is.na(data_clean)) ##counts all NAs shown in a table
```

```{r, examle search for NAs}

#examples for missing data grouping
data_clean %>%
  group_by(KT) %>% 
  summarise(NAs_per_W.Zimmer_count = sum(is.na(Zimmer))) #Lists all cantons and shows the sum of "NAs" for the column "Zimmer" including 0

data_clean %>%
     filter(is.na(Zimmer))  %>%
     count(KT) #Lists all cantons including "NAs" for the column "Zimmer" and sums them without including 0
```


```{r, MissingValues, echo=FALSE, fig.height = 10, fig.width = 17}
md.pattern(data_clean, rotate.names = TRUE) ##shows a table and a plot of the data for the NAs
```

The graphical presentation of missing values shows that there is high missing values in number of rooms, square meter of rooms,and entrance date. There is no action which is taken to remove or replace missing values and we will continue our analysis with the missing values included.


## Graphical Visualisation

Below we visualize the distribution of living area and correlating rental price.

```{r}
plot(y = data_clean$Miete,
     x = data_clean$W.Fläche,
     pch = "x",
     title("Rental Price per Appartment"),
           xlab = "living space in square meter",
           ylab = "rental price")

```

The above plot shows that the range of the area of rental apartments lays between 0 and 200 square meter and costs less than 5000 Swiss Francs. There are some outliers with a living area of above 300 and rental price above 10'000 Swiss Francs.


```{r}

ggplot(data_clean, aes(x=Miete, y=W.Fläche) ) +
  geom_hex(bons = 70) +
  scale_fill_continuous(type = "viridis") +
  theme_bw()
```

The above plot shows the same result as seen with the first plot, however with numerical metric.


## interactive Graphs

With the help of graphical functions we can produce quality interactive graphs for presentation, reporting, publication, etc. For this purpose we will produce some graphs using plotly.

###Plotly 1

```{r}

```

```{r}
#count W-Type per canton
count_W_Type <- data_clean %>% 
  group_by(KT) %>% 
  count(KT, sort = TRUE)


fig <- plot_ly(
  count_W_Type, x = ~KT, y = ~n, type = 'bar')
fig <- fig %>% layout(title = 'Apartments per canton',
                      xaxis = list(title = "Canton"),
                      yaxis = list(title = "Number apartments"))
fig

tmpFile <- tempfile(fileext = ".png")
export(fig, file = tmpFile)
```



###Plotly 2

```{r}
fig2 <- plot_ly(data_clean, y = ~G.Fläche, x = ~Einwohner_2019, type = 'scatter', mode = 'markers', size = 7,
        hoverinfo = 'text',
        text = ~paste('</br> Canton: ', Kanton,
                      '</br> Residents: ', Einwohner_2019,
                      '</br> Community area: ', G.Fläche))

fig2 <- fig2 %>% layout(title = 'Residents in 2019 against community area via canton',
                      xaxis = list(title = "Residents in 2019"),
                      yaxis = list(title = "Community area"))
fig2

tmpFile <- tempfile(fileext = ".png")
export(fig2, file = tmpFile)

fig2
```


```{r}
fig2 <- plot_ly(data = data_clean, x = ~Einwohner_2019, y = ~G.Fläche,
               marker = list(size = 10,
                             color = 'rgba(255, 182, 193, .9)',
                             line = list(color = 'rgba(152, 0, 0, .8)',
                                         width = 2)))

fig2 <- fig2 %>% layout(title = 'Styled Scatter',
         yaxis = list(title = "Canton"),
         xaxis = list(zeroline = FALSE),
         hoverinfo = 'text',
                             text = ~paste('</br> KT:', KT))

fig2

tmpFile <- tempfile(fileext = ".png")
export(fig2, file = tmpFile)

```

The interactive graph above shows the living space in every canton in relation to the amount of popullation.

## Further graphical visualisations


```{r}
ggplot(data_clean, aes(x=Miete, y=Zimmer, color=W.Type))+
  geom_point(size=2)
```

The above plot shows the type of rental housing available for rent colourfully. It shows that most of the rental objects available are apartments (pink colour).

```{r}
##

qplot(y = Zimmer, x = Miete, data = data_clean, facets = ~ W.Type)
```

The above graphs shows the same information as above however in a separately displayed plots. The plot is produced with qplot.

```{r fig.width=9, fig.height=7}
##

boxplot(Zimmer ~ W.Type, data = data_clean, main = "Average number of rooms of the rental objects")

```
The above boxplots visualizes the average number of rooms for different types of rental objects. Rental objects of type "Maisonettwohnung" have in average 5 rooms, where as Rental objects of type "Studio" have in average one room.

## Corellation matrix

To have a multi-dimensional visualization of several attributes, we visualize a correlation matrix. 

```{r fig.width=9, fig.height=7}
pairs(~Zimmer+Miete+W.Fläche+G.Fläche+Einwohner_2019,data=data_clean,
      main="Corellation Matrix of different attributes")

```


# Analysis
## The most expensive apartments
```{r}
top10 <- data_clean%>%top_n(n = 10, wt = Miete)

top10_sorted <- top10[order(top10$Miete, na.last=TRUE) , ]
top10_sorted

  
```

The most expensive apartment is located in the canton of Zurich and it costs 31'800 Swiss Francs per month. The 10th most expensive apartment costs 10'852 and it is located in the canton of Geneve.

## The biggest apartments

```{r}
top10 <- data_clean%>%top_n(n = 10, wt = W.Fläche)

top10_sorted <- top10[order(top10$W.Fläche, na.last=TRUE) , ]
top10_sorted
```

The biggest apartment available for rental is located in the canton of Graubünden and it has an area of 400 square meter. The 10th biggest Apartment has an area of 350 square meter and it is located in the canton of Zurich.



